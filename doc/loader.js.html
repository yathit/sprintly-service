<!DOCTYPE html>
<html>
<head>
    <meta charset="utf-8">
    <title>Source: loader.js</title>
    
    
    
    
    
    <meta property="og:title" content=""/>
    <meta property="og:type" content="website"/>
    <meta property="og:image" content=""/>
    
    <meta property="og:url" content=""/>
    
    <script src="scripts/prettify/prettify.js"></script>
    <script src="scripts/prettify/lang-css.js"></script>
    <script src="scripts/jquery.min.js"></script>
    <!--[if lt IE 9]>
      <script src="//html5shiv.googlecode.com/svn/trunk/html5.js"></script>
    <![endif]-->
    <link type="text/css" rel="stylesheet" href="styles/prettify-tomorrow.css">
    <link type="text/css" rel="stylesheet" href="styles/bootstrap.min.css">
    <link type="text/css" rel="stylesheet" href="styles/jaguar.css">
    
    
    <script>
    var config = {"monospaceLinks":true,"cleverLinks":true,"default":{"outputSourceFiles":true},"applicationName":"Sprint.ly offline service","disqus":"","googleAnalytics":"","openGraph":{"title":"","type":"website","image":"","site_name":"","url":""},"meta":{"title":"","description":"","keyword":""}};
    </script>
    

    
</head>
<body>
<div id="wrap" class="clearfix">
    
<div class="navigation">
    <h3 class="applicationName"><a href="index.html">Sprint.ly offline service</a></h3>

    <div class="search">
        <input id="search" type="text" class="form-control input-sm" placeholder="Search Documentations">
    </div>
    <ul class="list">
    
        <li class="item" data-name="sprintly">
            <span class="title">
                <a href="sprintly.html">sprintly</a>
                
                <span class="static">static</span>
                
            </span>
            <ul class="members itemMembers">
            
            <span class="subtitle">Members</span>
            
                <li data-name="sprintly.Entity"><a href="sprintly.html#Entity">Entity</a></li>
            
                <li data-name="sprintly.EventType"><a href="sprintly.html#EventType">EventType</a></li>
            
                <li data-name="sprintly.products"><a href="sprintly.html#products">products</a></li>
            
                <li data-name="sprintly.service"><a href="sprintly.html#service">service</a></li>
            
            </ul>
            <ul class="typedefs itemMembers">
            
            </ul>
            <ul class="methods itemMembers">
            
            <span class="subtitle">Methods</span>
            
                <li data-name="sprintly.login"><a href="sprintly.html#login">login</a></li>
            
                <li data-name="sprintly.run"><a href="sprintly.html#run">run</a></li>
            
            </ul>
            <ul class="events itemMembers">
            
            </ul>
        </li>
    
        <li class="item" data-name="sprintly.EntityList">
            <span class="title">
                <a href="sprintly.EntityList.html">sprintly.EntityList</a>
                
            </span>
            <ul class="members itemMembers">
            
            <span class="subtitle">Members</span>
            
                <li data-name="sprintly.EntityList#entity"><a href="sprintly.EntityList.html#entity">entity</a></li>
            
                <li data-name="sprintly.EntityList#limit"><a href="sprintly.EntityList.html#limit">limit</a></li>
            
                <li data-name="sprintly.EntityList#name"><a href="sprintly.EntityList.html#name">name</a></li>
            
                <li data-name="sprintly.EntityList#offset"><a href="sprintly.EntityList.html#offset">offset</a></li>
            
                <li data-name="sprintly.EntityList#product"><a href="sprintly.EntityList.html#product">product</a></li>
            
                <li data-name="sprintly.EntityList#records"><a href="sprintly.EntityList.html#records">records</a></li>
            
                <li data-name="sprintly.EntityList#refractoryPeriod"><a href="sprintly.EntityList.html#refractoryPeriod">refractoryPeriod</a></li>
            
            </ul>
            <ul class="typedefs itemMembers">
            
            </ul>
            <ul class="methods itemMembers">
            
            <span class="subtitle">Methods</span>
            
                <li data-name="sprintly.EntityList#dispose"><a href="sprintly.EntityList.html#dispose">dispose</a></li>
            
                <li data-name="sprintly.EntityList#get"><a href="sprintly.EntityList.html#get">get</a></li>
            
                <li data-name="sprintly.EntityList#onChanged"><a href="sprintly.EntityList.html#onChanged">onChanged</a></li>
            
                <li data-name="sprintly.EntityList#size"><a href="sprintly.EntityList.html#size">size</a></li>
            
            </ul>
            <ul class="events itemMembers">
            
            </ul>
        </li>
    
        <li class="item" data-name="sprintly.Product">
            <span class="title">
                <a href="sprintly.Product.html">sprintly.Product</a>
                
            </span>
            <ul class="members itemMembers">
            
            <span class="subtitle">Members</span>
            
                <li data-name="sprintly.Product.EventObject"><a href="sprintly.Product.html#EventObject">EventObject</a></li>
            
                <li data-name="sprintly.Product.schema"><a href="sprintly.Product.html#schema">schema</a></li>
            
                <li data-name="sprintly.Product#db"><a href="sprintly.Product.html#db">db</a></li>
            
                <li data-name="sprintly.Product#hibernatePeriod"><a href="sprintly.Product.html#hibernatePeriod">hibernatePeriod</a></li>
            
                <li data-name="sprintly.Product#Item"><a href="sprintly.Product.html#Item">Item</a></li>
            
                <li data-name="sprintly.Product#onReady"><a href="sprintly.Product.html#onReady">onReady</a></li>
            
                <li data-name="sprintly.Product#People"><a href="sprintly.Product.html#People">People</a></li>
            
                <li data-name="sprintly.Product#product"><a href="sprintly.Product.html#product">product</a></li>
            
                <li data-name="sprintly.Product#refractoryPeriod"><a href="sprintly.Product.html#refractoryPeriod">refractoryPeriod</a></li>
            
                <li data-name="sprintly.Product#service"><a href="sprintly.Product.html#service">service</a></li>
            
            </ul>
            <ul class="typedefs itemMembers">
            
            </ul>
            <ul class="methods itemMembers">
            
            <span class="subtitle">Methods</span>
            
                <li data-name="sprintly.Product#add"><a href="sprintly.Product.html#add">add</a></li>
            
                <li data-name="sprintly.Product#dispose"><a href="sprintly.Product.html#dispose">dispose</a></li>
            
                <li data-name="sprintly.Product#get"><a href="sprintly.Product.html#get">get</a></li>
            
                <li data-name="sprintly.Product#getEntityByName"><a href="sprintly.Product.html#getEntityByName">getEntityByName</a></li>
            
                <li data-name="sprintly.Product#list"><a href="sprintly.Product.html#list">list</a></li>
            
                <li data-name="sprintly.Product#put"><a href="sprintly.Product.html#put">put</a></li>
            
                <li data-name="sprintly.Product#remove"><a href="sprintly.Product.html#remove">remove</a></li>
            
                <li data-name="sprintly.Product#request"><a href="sprintly.Product.html#request">request</a></li>
            
            </ul>
            <ul class="events itemMembers">
            
            </ul>
        </li>
    
        <li class="item" data-name="sprintly.Service">
            <span class="title">
                <a href="sprintly.Service.html">sprintly.Service</a>
                
            </span>
            <ul class="members itemMembers">
            
            <span class="subtitle">Members</span>
            
                <li data-name="sprintly.Service.BASE_URL"><a href="sprintly.Service.html#BASE_URL">BASE_URL</a></li>
            
                <li data-name="sprintly.Service#authHeader"><a href="sprintly.Service.html#authHeader">authHeader</a></li>
            
                <li data-name="sprintly.Service#products"><a href="sprintly.Service.html#products">products</a></li>
            
                <li data-name="sprintly.Service#username"><a href="sprintly.Service.html#username">username</a></li>
            
            </ul>
            <ul class="typedefs itemMembers">
            
            </ul>
            <ul class="methods itemMembers">
            
            <span class="subtitle">Methods</span>
            
                <li data-name="sprintly.Service#getProfile"><a href="sprintly.Service.html#getProfile">getProfile</a></li>
            
                <li data-name="sprintly.Service#listProducts"><a href="sprintly.Service.html#listProducts">listProducts</a></li>
            
                <li data-name="sprintly.Service#login"><a href="sprintly.Service.html#login">login</a></li>
            
                <li data-name="sprintly.Service#onNetwork"><a href="sprintly.Service.html#onNetwork">onNetwork</a></li>
            
                <li data-name="sprintly.Service#request"><a href="sprintly.Service.html#request">request</a></li>
            
                <li data-name="sprintly.Service#setProfile"><a href="sprintly.Service.html#setProfile">setProfile</a></li>
            
            </ul>
            <ul class="events itemMembers">
            
            </ul>
        </li>
    
    </ul>
</div>
    <div class="main">
        <h1 class="page-title" data-filename="loader.js.html">Source: loader.js</h1>
        


    
    <section>
        <article>
            <pre class="prettyprint source"><code>/**
 * @fileOverview Sprintly service loader.
 *
 * Service loader handle persisting user profile, managing sprintly product and network aware connection to backend
 * services. Service loader dispatch important events such as `sprintly-ready`, `sprintly-login` and `sprintly-logout`
 * events to `window`.
 *
 * @author kyawtun@yathit.com (Kyaw Tun)
 */


/**
 * @type {sprintly.Service} main service.
 * @final
 */
sprintly.service = new sprintly.Service();


/**
 * Events dispatch to window.
 * @enum {string}
 */
sprintly.EventType = {
  /** Login event */
  LOGIN: 'sprintly-login',
  /** Login fail event */
  LOGIN_FAIL: 'sprintly-login-fail',
  /** Logout event */
  LOGOUT: 'sprintly-logout',
  /** Service ready event */
  READY: 'sprintly-ready'
};


/**
 * @type {Object.&lt;sprintly.Product>} products belong to login user.
 * @export
 */
sprintly.products = {};


/**
 * @param {Array.&lt;Sprintly.Product>} products list of product resources.
 * @return {Promise} Resolve with list of products.
 * @private
 */
sprintly.prepareProducts = function(products) {
  for (var id in sprintly.products) {
    if (!products.some(function(p) {
      return p.id == id;
    })) {
      this.products[id].dispose();
      delete this.products[id];
    }
  }
  for (var i = 0; i &lt; products.length; i++) {
    var prod = products[i];
    if (!sprintly.products[prod.id]) {
      sprintly.products[prod.id] = new sprintly.Product(sprintly.service, prod);
    }
  }
  var db_ready = [];
  for (var name in sprintly.products) {
    db_ready.push(sprintly.products[name].onReady);
  }
  return Promise.all(db_ready).then(function() {
    return sprintly.products;
  });
};


/**
 *
 * @param {string} username user id.
 * @param {string} password sprint.ly API key
 * @param {boolean=} remember keep username and password.
 * @return {Promise}
 * @export
 */
sprintly.login = function(username, password, remember) {
  if (remember === false) {
    localStorage.removeItem('user-profile');
  }
  return sprintly.service.login(username, password).then(function(products) {
    var profile = sprintly.service.getProfile();
    if (remember) {
      localStorage.setItem('user-profile', JSON.stringify(profile));
    } else {
      sessionStorage.setItem('user-profile', JSON.stringify(profile));
    }
    window.dispatchEvent(new CustomEvent(sprintly.EventType.LOGIN));
    return sprintly.prepareProducts(products).then(function() {
      window.dispatchEvent(new CustomEvent(sprintly.EventType.READY));
    })
  }, function(e) {
    localStorage.removeItem('user-profile');
    sessionStorage.removeItem('user-profile');
    for (var id in sprintly.products) {
      sprintly.products[id].dispose();
      delete sprintly.products[id];
    }
    window.dispatchEvent(new CustomEvent('sprintly-login-fail'));
  });
};


/**
 * Run sprintly loader.
 * This will dispatch `ready` event if user already login on previous session.
 * @return {Promise} If user has valid session, resolve user profile, otherwise reject with `false`.
 * @export
 */
sprintly.run = function() {
  var profile = localStorage.getItem('user-profile') || sessionStorage.getItem('user-profile');
  if (profile) {
    profile = JSON.parse(profile);
    sprintly.service.setProfile(profile);
    return sprintly.prepareProducts(profile.products).then(function() {
      var event = new CustomEvent(sprintly.EventType.READY, {
        detail: {
          profile: profile
        }
      });
      window.dispatchEvent(event);
    });
  } else {
    return Promise.reject(false);
  }
};


</code></pre>
        </article>
    </section>





        

        <footer>
            <div>Generated by <a href="https://github.com/jsdoc3/jsdoc">JSDoc 3.3.0-alpha9</a> on Fri Jul 18 2014 17:39:28 GMT+0800 (SGT)</div>
            Powered by <a href="http://dev.yathit.com">YDN-DB</a>. <a href="https://github.com/yathit/sprintly-service">Project home</a>. Product of Yathit.
        </footer>
    </div>
</div>
<script>prettyPrint();</script>
<script src="scripts/linenumber.js"></script>
<script src="scripts/main.js"></script>
</body>
</html>
